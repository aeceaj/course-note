# COMPUTER NETWORKS

[toc]

## 概述

### 计算机网络的组成

1. 组成部分

   - 硬件：主机、通信链路、交换设备、通信处理机等
   - 软件：多属于应用层
   - 协议：规定网络传输遵循的规范

2. 工作方式

   - 边缘部分：所有连接到 Internet，供用户直接使用的主机
   - 核心部分：大量的网络和连接到这些网络的路由器

3. 功能组成

   - 通信子网：传输介质、通信设备、网络协议，实现计算机间数据通信
   - 资源子网：实现资源共享功能的设备及软件

### 计算机网络的功能

1. 数据通信
2. 资源共享：可以是软件共享、数据共享，也可以是硬件共享
3. 分布式处理
4. 提高可靠性：各台计算机通过网络互为替代机
5. 负载均衡

### 计算机网络的分类

1. 按分布范围

   - 广域网（WAN，远程网）
     : 提供长距离通信，因特网的和核心部分。使用交换技术
   - 城域网（MAN）
     : 跨越几个街区甚至整个城市，大多采用以太网
   - 局域网（LAN）
     : 覆盖范围较小。使用广播技术
   - 个人区域网（PAN）
     : 用于个人工作场所

2. 按传输技术

   - 广播式网络
     : 所有计算机共享一个公共通信信道。用于局域网，以及广域网中的无线、卫星通信网络
   - 点对点网络
     : 每条物理线路连接一对计算机。没有直接线路则通过中间结点接收、存储和转发。用于广域网

   :memo: 两者重要区别：是否采用分组存储转发与路由选择机制

3. 按拓扑结构

   - 总线形
     : 单根传输线连接计算机

      :+1: 建网容易、增减节点方便、节省线路  
      :-1: 重负载效率不高，总线对故障敏感

   - 星形
     : 计算机通过单独线路与中央设备连接，中央设备一般是交换机或路由器

     :+1: 便于集中控制和管理  
     :-1: 成本高，中央设备对故障敏感

   - 环形
     : 所有计算机接口设备连城一个环，典型例子是令牌环局域网。环中信号单向传输
   - 网状
     : 多用在广域网中

     :+1: 可靠性高  
     :-1: 控制复杂，线路成本高

4. 按使用者

   - 公用网（Public Network）
     : 电信公司出资建造的大型网络，也称公众网
   - 专用网（Private Network）
     : 某个部门为满足本单位特殊业务需要建造的网络，不向本单位以外的人提供服务

5. [按交换技术](#交换技术)

   - 电路交换网络
     : 源结点和目的结点之间建立一条专用的通路。如传统电话网络

     :+1: 数据直接传送，时延小  
     :-1: 线路利用率低，不能充分利用线路容量，不便于差错控制

   - 报文交换网络（存储-转发网络）
     : 用户数据与辅助信息封装为报文，经存储-转发到达目的结点

     :+1: 较充分地利用线路容量，实现不同链路之间不同传输速率的转换、格式转换，一对多、多对一访问，差错控制  
     :-1: 增大资源开销，增加缓冲时延，报文大小不固定，缓冲区难以管理

   - 分组交换网络（包交换网络）
     : 数据分成固定长度的数据块，加上辅助信息组成分组（包），存储-转发方式传输

     :+1: 缓冲易于管理，平均时延更小，占用平均缓冲区更少，易于标准化

     主流网络基本可视为分组交换网络

6. 按传输介质

   - 有线：双绞线网络、同轴电缆网络等
   - 无线：蓝牙、微波、无线电等

### 计算网络的标准化工作

因特网的所有标准以 RFC（Request For Comments）形式发布。RFC 上升为因特网的正式标准需经过 4 个阶段

1. 因特网草案（Internet Draft）
2. 建议标准（Proposed Standard）此时开始成为 RFC 文档
3. 草案标准（Draft Standard）
4. 因特网标准（Internet Standard）

制定、实施相关网络标准化的标准化组织

- 国际标准化组织（ISO）
- 国际电信联盟（ITU）
- 国际电气电子工程师协会（IEEE）

### 计算机网络的性能指标

1. 带宽（Bandwidth）
   : 最高数据传输速率
2. 时延（Delay）
   : 数据从网络一端传送到另一端所需要的总时间。分 4 个部分

   - 发送时延（传输时延）：结点将分组的所有比特推向链路所需要的时间。从发送第一个比特到最后一个比特发送完毕

     $$ \text{发送时延}=\frac{\text{分组长度}}{\text{信道宽度}} $$

   - 传播时延：在信道中传播一定距离花费的时间。一个比特从链路一端到另一端

     $$ \text{传播时延}=\frac{\text{信道长度}}{\text{电磁波在信道上的传播速率}} $$

   - 处理时延：数据在交换结点进行必要处理花费的时间。如分析分组首部、提取数据部分、进行差错校验、查找适当路由等
   - 排队时延：分组进入路由器后在输入队列中排队等待处理，在输出队列中排队等待转发

   :memo: 排队时延和处理时延一般可忽略不计。高速链路仅提高数据发送速率，减少发送时延

3. 时延带宽积
   : 发送的第一个比特即将到达终点时已发送了多少比特，又称以比特为单位的链路长度

   $$ \text{时延带宽积}=\text{传播时延}\times\text{信道带宽} $$

4. 往返时延（Round-Trip Time，RTT）
   : 从发送端发出数据开始，到收到接收端的确认。包括各中间结点的处理时延、排队时延、转发时的发送时延
5. 吞吐量（Throughput）
   : 单位时间内通过某个网络（或信道、接口）的数据量，受网络带宽限制
6. 速率（Speed）
   : 也称数据传输速率、数据率、比特率。最高数据传输速率即带宽
7. 信道利用率
   : 有百分之多少时间有数据通过

### 计算机网络分层

1. 每层功能相对独立，降低大系统复杂度
2. 各层之间界面清晰，交流尽可能少
3. 功能的定义独立于实现方法
4. 下层对上层独立，上层使用下层提供的服务
5. 分层结构能促进标准化工作

#### 各层报文组成

1. 服务数据单元（SDU）
   : 完成用户要求的功能传送的数据，数据部分。第 $n$ 层的记为 n-SDU
2. 协议控制信息（PCI）
   : 控制协议操作的信息，控制信息部分。第 $n$ 层的记为 n-PCI
3. 协议数据单元（PDU）
   : 对等层次之间传送的数据单位，由 SDU 和 PCI 组成。第 $n$ 层的记为 n-PDU

   物理层：比特  
   数据链路层：帧  
   网络层：分组  
   传输层：报文段

传输时把从 $n+1$ 层收到的 PDU 作为 $n$ 层的 SDU，加上 $n$ 层的 PCI 组成 $n$ 层的 PDU，交给 $n-1$ 层作为 SDU 发送

$$ n\text{-SDU}+n\text{-PCI}=n\text{-PDU}=(n-1)\text{-SDU} $$

#### 层次结构含义

1. 每一层使用下一层的服务实现自身定义的功能，并向上一层提供本层的服务，该服务是该层及下面各层服务的总和
2. 最低层只提供服务，整个层次结构的基础；中间层是下层的服务使用者，上层的服务提供者；最高层面向用户提供服务
3. 上一层通过相邻层间接口使用下一层的服务，不能调用其他层的服务；下一层服务的实现细节对上一层透明
4. 通信时，对等层在逻辑上有一条直接信道，表现为不经过下层就把信息传送给对方

### 协议、接口、服务

#### 协议

为进行网络中的数据交换而建立的规则、标准或约定，控制两个或多个对等实体进行通信，是水平的  
不对等实体间没有协议

- 语法：规定传输数据的格式
- 语义：规定所要完成的功能
- 同步：规定执行各种操作的条件、时序关系等

协议通常具有线路管理（建立、释放连接）、差错控制、数据转换等功能

#### 接口

同一结点内相邻两层间交换信息的连接点，只为紧邻的层次之间定义接口  
层间实体通过服务访问点（Service Access Point, SAP）进行交互，服务通过 SAP 提供给上层  
每个 SAP 有一个可以标识它的地址。SAP 是一个逻辑接口，抽象概念

#### 服务

下层为紧邻的上层提供的功能调用，是垂直的  
上层使用下层的服务时必须与下层交换一些命令，在 OSI 参考模型中称为**服务原语**：

1. 请求（Request）：服务用户 $\to$ 服务提供者，请求完成某项工作
2. 指示（Indication）：服务提供者 $\to$ 服务用户，指示用户做某件事情
3. 响应（Response）：服务用户 $\to$ 服务提供者，对指示的响应
4. 证实（Confirmation）：服务提供者 $\to$ 服务用户，对请求的证实

:memo: 有应答服务包括全部 4 类原语，无应答服务只包括请求和指示

本层协议的实现才能保证向上一层提供服务  
并非在一层内完成的全部功能都称为服务，只有能被高一层看见的功能才能称为服务

服务分类：

1. 面向连接服务/无连接服务：通信双方是否需要先建立连接
2. 可靠服务/不可靠服务：是否具有纠错、检错、应答机制，保证数据正确可靠地传送到目的地。在不可靠服务中，网络的正确性、可靠性由应用或用户保证
3. 有应答服务/无应答服务：接收方在收到数据后是否向发送方给出相应的应答。应答由传输系统内部自动实现

### OSI 参考模型

1. 物理层（Physical Layer）

   - 传输单位：比特
   - 任务：在物理媒体上为数据端设备透明地传输原始比特流
   - 功能：主要定义数据设备终端（DTE）和数据通信设备（DCE）的物理与逻辑连接方法，物理层协议也称物理层接口标准
   - 协议：EIA-232C、EIA/TIA RS-449、CCITT 的 X.21 等

   规定通信链路与通信结点连接的电路接口参数，规定通信链路上传输的信号的意义和电气特征

   :memo: 传输信息所用的物理媒体（双绞线、光缆等）在物理层协议以下（“第 0 层”）

2. 数据链路层（Data Link Layer）

   - 传输单位：帧
   - 任务：将网络层传来的IP数据报组装成帧
   - 功能：成帧、差错控制、流量控制和传输管理等
   - 协议：SDLC、[HDLC](#hdlchigh-level-data-link-control高级数据链路控制协议)、[PPP](#ppp-协议point-to-point-protocol)、STP 和帧中继等

   差错控制用于检测由于外界噪声干扰产生的差错，将错误信息丢弃  
   流量控制用于协调两个结点的速率  
   特殊的子层介质访问子层用于控制对共享信道的访问

3. 网络层（Network Layer）

   - 传输单位：数据报
   - 任务：通信子网的运行控制，把网络层的协议数据单元（分组）从源端传到目的端
   - 功能：对分组进行路由选择，实现流量控制、拥塞控制、差错控制和网际互连等
   - 协议：[IP](#ipv4)、IPX、[ICMP](#网际控制报文协议internet-control-message-protocol-icmp)、[IGMP](#igmp-与组播路由算法)、[ARP](#地址解析协议address-resolution-protocol-arp)、RARP 和 [OSPF](#开放最短路径优先ospf协议) 等

   流量控制用于协调发送速率和接收速率  
   差错控制是两结点间约定的特定检错规则，如奇偶校验码，如出现差错则进行纠错，或丢弃  
   拥塞控制采取一定措施缓解拥塞

4. 传输层（Transport Layer）

   - 传输单位：报文段（TCP）或用户数据报（UDP）
   - 任务：负责主机中两个进程之间的通信
   - 功能：为端到端连接提供可靠的传输服务，流量控制、差错控制、服务质量、数据传输管理等
   - 协议：[TCP](#tcp-协议-transmission-control-protocol)、[UDP](#udp-协议user-datagram-protocol)

   数据链路层提供点到点的通信，主机之间；传输层提供端到端的通信，进程之间  
   复用：多个应用层进程可同时使用下面传输层的服务  
   分用：传输层把收到的信息分别交付给上面应用层中相应的进程

5. 会话层（Session Layer）

   允许不同主机上各个进程间进行会话

6. 表示层（Presentation Layer）

   处理两个通信系统中交换信息的表示方式

7. 应用层（Application Layer）

   用户与网络的界面，为特定类型的网络应用提供访问 OSI 参考模型环境的手段  
   要求应用层采用不同的应用协议解决不同类型的应用要求，最为复杂，协议最多  
   典型协议：[FTP](#文件传输协议file-transfer-protocol-ftp)、[SMTP](#简单邮件传输协议simple-mail-transfer-protocol-smtp)、[HTTP](#超文本传输协议hyper-text-transmission-protocol-http) 等

低三层统称为**通信子网**，高三层统称为**资源子网**

### TCP/IP 模型

1. 网络接口层

   - 对应：物理层、数据链路层
   - 功能：从主机或结点接收 IP 分组，发送到指定的物理网络

2. 网际层（主机 - 主机）

   - 对应：网络层
   - 功能：将分组发往任何网络，并为之独立地选择合适的路由，不保证有序到达。定义了标准的分组格式和协议，即 IP

3. 传输层（应用 - 应用/进程 - 进程）

   - 对应：传输层
   - 功能：使得发送端和目的端主机上的对等实体进行会话

   1. 传输控制协议（Transmission Control Protocol, TCP）：面向连接，传输单位报文段，提供可靠的交付
   2. 用户数据报协议（User Datagram Protocol, UDP）：无连接，传输单位用户数据报，不保证提供可靠的交付，尽最大努力交付

4. 应用层（用户 - 用户）

   - 对应：会话层、表示层、应用层
   - 包含所有高层协议：Telnet、FTP、DNS、SMTP、HTTP 等

OSI 模型在网络层支持无连接和面向连接，在传输层仅支持面向连接  
TCP/IP 模型在网际层仅支持无连接，在传输层支持无连接和面向连接

## 物理层

### 通信基础

#### 数据、信号、码元

数据：传送信息的实体  
信号：数据的电气或电磁表现，数据传输过程中的存在形式  
模拟数据/信号：连续变化的数据/信号  
数字数据/信号：取值仅允许为有限的几个离散数值的数据/信号

数据传输方式分为串行传输和并行传输。远距离通信通常采用串行传输

码元：用一个固定时长的信号波形（数字脉冲）表示一位 $k$ 进制数字。数字信号计量单位，称为 $k$ 进制码元  
1 码元可以携带若干比特信息量

#### 信源、信道、信宿

信源：产生和发送数据的源头  
信宿：接收数据的终点  
一条通信线路往往包含一条发送信道和一条接收信道

信道 $\to$ 变换器 $\to$ 信道（噪声源） $\to$ 反变换器 $\to$ 信宿

信道按传输信号形式分：模拟信道/数字信道；按传输介质分：无线信道/有线信道

- 基带传输：基带信号将 1 和 0 用不同的电压表示，送到数字信道上传输
- 宽带传输：宽带信号将基带信号进行调制后形成频分复用模拟信号，送到模拟信道上传输

通信双方信息交互方式：

1. 单向通信
   : 只有一个方向的通信，仅需一条信道。如无线电广播、电视广播
2. 半双工通信
   : 通信双方都可发送或接收信息，任何一方不能同时发送和接收信息，需要两条信道
3. 全双工通信
   : 通信双方可以同时发送和接收信息，需要两条信道

#### 速率、波特与带宽

1. 码元传输速率（波特率）
   : 单位时间数字通信系统传输的码元个数，单位波特（Baud）。码元速率与进制无关
2. 信息传输速率（信息速率，比特率）
   : 单位时间数字通信系统传输的二进制码元个数，即比特数，单位比特/秒（b/s）

若一个码元携带 $n$ 比特信息量，则 $M$ 波特对应 $Mn$ 比特/秒

#### 奈奎斯特（Nyquist）定理（奈氏准则）

在理想低通（没有噪声，带宽有限）信道中为了避免码间串扰，极限码元传输速率为 $2W$ 波特，其中 $W$ 为理想低通信道的带宽，$V$ 为每个码元离散电平的数目（即有多少种不同的码元）

$$ 理想低通信道下的极限数据传输速率=2W\log_2V\ (\text{b/s}) $$

1. 任何信道中码元传输速率是有上限的，超过这一上限就会出现严重的码间串扰
2. 信道的频带越宽，就可以用更高的速率进行码元的有效传输
3. 奈氏准则给出了码元传输速率的限制，但没有对信息传输速率给出限制。因此要提高数据传输速率，就要让每个码元携带更多比特的信息量

#### 香农（Shannon）定理

带宽受限且有高斯白噪声干扰的信道，设信道带宽为 $W$，信道传输信号的平均功率为 $S$，信道内部的高斯噪声功率为 $N$，不产生误差的极限数据传输速率为

$$ \text{信道的极限数据传输速率}=W\log_2(1+\frac{S}{N})\ (\text{b/s}) $$

信噪比：信号的平均功率与噪声的平均功率之比

$$ \text{信噪比}=10\log_{10}\frac{S}{N}\ (\text{dB}) $$

1. 信道的带宽或信噪比越大，极限传输速率越高
2. 对一定的传输带宽和一定的信噪比，信息传输速率的上限是确定的
3. 只要信息传输速率低于极限传输速率，就能找到某种方法实现无差别的传输
4. 实际信道能达到的传输速率比极限传输速率低不少

香农定理同时考虑到了带宽和信噪比，侧面表明一个码元对应的二进制位数是有限的

#### 编码与调制

调制：数据 $\to$ 模拟信号  
编码：数据 $\to$ 数字信号

1. 数字数据编码为数字信号

   - 归零编码（RZ）
     : 高电平代表 1，低电平代表 0，每个时钟周期的中间均跳变到低电平

     接收方根据跳变调整时钟，为传输双方提供自动同步机制  
     归零需要占用一部分带宽，传输效率受影响

   - 非归零编码（NRZ）
     : 不用归零，一个周期全部用来传输数据

     无法传递时钟信号，实现同步需要带有时钟线

   - 反向非归零编码（NRZI）
     : 用信号的翻转代表 0，信号不变代表 1

     翻转的信号可以作为通知机制传输时钟信号，又能尽量不损失系统带宽  
     例如：USB 2.0

   - 曼彻斯特编码（Manchester Encoding）
     : 将一个码元分成两个相等的间隔，高-低表示 1，低-高表示 0（也可相反）

     中间的跳变可作为时钟信号，又作为数据信号  
     需要的频带宽度是原始基带宽度的两倍  
     例如：以太网

   - 差分曼彻斯特编码
     : 前半电平与上一码元的后半电平相同，表示 1；前半电平与上一码元的后半电平相反，表示 0

     中间的跳变可实现自动同步，抗干扰性较好  
     常用于局域网传输

   - 4B/5B 编码
     : 数据流 4 位作为一组，按照 4B/5B 编码规则转换成相应的 5 位码

     5 位码的 16 种组合对应 4 位码，其他 16 种作为控制码或保留

2. 数字数据调制为模拟信号

   - 幅移键控（ASK）
     : 改变载波信号的振幅来表示 1 和 0，频率和相位不变

     比较容易实现  
     抗干扰能力差

   - 频移键控（FSK）
     : 改变载波信号的频率来表示 1 和 0，振幅和相位不变

     容易实现，抗干扰能力强  
     应用较为广泛

   - 相移键控（PSK）
     : 改变载波信号的相位来表示 1 和 0，振幅和频率不变

     分为绝对调相和相对调相

   - 正交振幅调制（QAM）
     : 在频率相同的前提下，将 ASK 与 PSK 相结合形成叠加信号

     设波特率为 $B$，采用 $m$ 个相位，每个相位 $n$ 种振幅，则传输速率 $R$ 为

     $$ R=B\log_2(mn) $$

3. 模拟数据编码为数字信号

   常用于对音频信号进行编码的脉码调制（PCM）

   采样定理（奈奎斯特定理）：采样频率须大于等于最大频率的两倍，才能保证采样后的数字信号完整保留原始模拟信号的信息

   1. 采样：对模拟信号进行周期性扫描，把时间上连续的信号变成时间上离散的信号
   2. 量化：把采样取得的电平幅值按一定分级标度转化为对应数字值并取整，将连续的电平幅值转换为了离散的数字量
   3. 编码：把量化的结果转换为与之对应的二进制编码

4. 模拟数据调制为模拟信号

   可能需要较高的频率  
   可以使用频分复用（FDM），充分利用带宽资源  
   用于电话和本地局交换机

### 交换技术

#### 电路交换

进行数据传输之前，两个结点先建立一条专用的物理通信路径，可能经过许多中间结点  
路径在整个数据传输期间一直被独占，通信结束后被释放  
分为连接建立、数据传输、连接释放三个阶段

:+1:

1. 通信时延小
2. 有序传输
3. 没有冲突
4. 适用范围广
5. 实时性强
6. 控制简单：交换设备及控制均较简单

:-1:

1. 建立连接时间长
2. 线路独占，使用效率低
3. 灵活性差：通路中出现故障就必须重新拨号建立连接
4. 难以规格化：不同类型、规格、速率的终端难以相互通信，难以差错控制

:memo: 电路上的结点采取“直通方式”接收和发送数据，不存在存储转发耗费的时间

#### 报文交换

数据交换的单位是报文，携带有目标地址、源地址等信息  
在交换结点采用存储转发的传输方式

:+1:

1. 无需建立连接
2. 动态分配线路
3. 提高线路可靠性：某条传输路径发生故障，可重新选择另一条路径
4. 提高线路利用率：不固定占有一条通信线路，而是在不同时间部分占有
5. 提供多目标服务：一个报文可同时发送给多个目的地址

:-1:

1. 存储转发产生转发时延
2. 报文大小不加限制，要求结点有较大的缓存空间

:memo: 主要用在早期电报通信网，现在较少使用

#### 分组交换

采用存储转发  
限制每次传送的数据块大小上限，大数据块划分为小数据块  
加上必要的控制信息构成分组（Packet）

:+1:

1. 无建立时延
2. 线路利用率高
3. 简化了存储管理：分组长度固定，缓冲区大小固定，对缓冲区的管理较为容易
4. 加速传输：后一个分组的存储可以和前一个分组的转发并行；缓冲区不足的概率小
5. 减少了出错概率和重发数据量

:-1:

1. 存在传输时延
2. 需要传输额外的信息量
3. 可能出现失序、丢失或重复分组：到达目的结点时需要对分组按编号进行排序

### 数据报与虚电路

分组交换根据网络层提供的服务，分为虚电路（面向连接）、数据报（无连接）

#### 数据报

发送报文时拆成若干有序号的数据单元，加上控制信息形成数据报分组（网络层 PDU）

1. 不需要建立连接
2. 尽最大努力交付，不保证可靠；分组独立选择路由，不一定按序到达
3. 分组中包括发送端和接受端的完整地址，以便独立传输
4. 在交换结点中需要排队等候处理，产生时延。拥塞时可能被丢弃
5. 有冗余路径，对故障的适应能力强
6. 存储转发的时延较小，提高网络吞吐量
7. 不独占链路，资源利用率高

#### 虚电路

发送前建立逻辑上相连的虚电路，固定了对应的物理路径  
有虚电路建立、数据传输、虚电路释放三个阶段

建立虚电路时选择一个未用过的虚电路号分配  
数据分组还包括虚电路号  
每个结点维持一张虚电路表，记录虚电路信息：虚电路号、前一结点、下一结点

1. 建立和释放需要时间开销，对长时间、频繁的数据交换效率较高
2. 连接建立阶段进行路由选择，建立后路径确定
3. 提供可靠通信功能，保证分组正确、有序到达；可进行流量控制
4. 某个结点故障时，所有经过该点的虚电路被破坏
5. 分组首部不包含目的地址，而是虚电路号，开销相对小

### 传输介质

- 导向传输介质：导向沿着固体媒介传播
- 非导向传输介质：空气、真空、海水等

#### 双绞线、同轴电缆、光纤、无线传输介质

1. 双绞线
   : 两根并排绞合的、互相绝缘的铜导线

   绞合减少对相邻导线的电磁干扰

   - 屏蔽双绞线（STP）：外侧加上金属丝编织的屏蔽层
   - 非屏蔽双绞线（UTP）

   价格便宜，常用传输介质之一  
   局域网和传统电话网中普遍使用

2. 同轴电缆
   : 由内导体、绝缘层、网状编织屏蔽层和塑料外层构成

   - $50\Omega$ 同轴电缆（基带同轴电缆）：传送基带数字信号。用于局域网
   - $75\Omega$ 同轴电缆（宽带同轴电缆）：传送宽带信号。用于有线电视系统

   具有良好的抗干扰特性，广泛用于传输较高速率的数据，传输距离更远  
   价格较贵

3. 光纤
   : 利用光导纤维传递光脉冲。由纤芯（高折射率）和包层（低折射率）构成

   - 多模光纤：不同入射角的多条光线在一根光纤中传输，光源为发光二极管。只适合近距离传输
   - 单模光纤：光纤直径只有一个光的波长，光线一直向前传播，光源为半导体激光器。成本较高，适合远距离传输

   带宽范围极大，通信容量大，传输损耗小，抗雷电和电磁干扰性能好，体积小重量轻

4. 无线传输介质

   - 无线电波：穿透力强，传输距离长，向所有方向散播。无线手机通信、无线局域网（WLAN）
   - 微波、红外线和激光：需要视线通路，沿直线传播，方向性强

#### 物理层接口特性

1. 机械特性：接线器形状和尺寸、引脚数目和排列等
2. 电气特性：接口电缆各条线上的电压范围
3. 功能特性：某条线上某一电平的意义
4. 过程特性（规程特性）：对于不同功能的各种可能事件的出现顺序

常用物理层接口标准：EIA RS-232-C、ADSL、SONET/SDH 等

### 物理层设备

1. 中继器
   : 将信号整形并放大再转发出去，原理是信号整形再生

   两端的网络部分是网段，多个网段仍属于一个局域网  
   不能连接具有不同速率的局域网  
   放大数字信号

   :memo: 放大器用于放大模拟信号，原理是放大衰减的信号

2. 集线器（Hub）
   : 多端口的中继器，信号再生后转发到所有工作端口（除输入端口）。多个端口输入会发生冲突

   使用双绞线组建共享网络，从服务器连接到桌面的最经济方案  
   连接不同网段  
   仅支持半双工  
   所有端口属于同一个冲突域，多台机器同时通信将导致信息碰撞

## 数据链路层

### 数据链路层的功能

将物理层提供的可能出错的物理连接改造为逻辑上无差错的数据链路

1. 为网络层提供服务

   - 无确认的无连接服务：丢失帧不重发，交给上层处理。适用于实时通信或误码率较低的信道，如以太网
   - 有确认的无连接服务：未收到确认则重传丢失帧。适用于误码率较高的信道，如无线通信
   - 有确认的面向连接服务：建立数据链路 $\to$ 传输帧 $\to$ 释放数据链路，收到确认后发送下一帧。可靠性最高，适用于通信要求较高的场合

   :memo: 有连接就一定要有确认

2. 链路管理

   连接的建立、维持和释放  
   首先确认对方处于就绪状态，交换必要信息，对帧序号初始化，之后建立连接

3. 帧定界、帧同步、透明传输

   - 帧定界：确定帧的界限，由首部和尾部的控制信息实现
   - 帧同步：接收方从比特流中区分出帧的起始和终止
   - 透明传输：保证任意比特组合均能在链路上传输（如与帧定界符相同的比特组合）

4. 流量控制

   :memo: TCP/IP 模型中，流量控制功能被移到了传输层

5. 差错控制

   - 位错：帧中某些位出现了差错。通过 CRC 发现，通过 ARQ 重传
   - 帧错：帧的丢失、重复或失序。引入定时器和编号机制

### 组帧

组帧既要加首部，又要加尾部，用于标记帧在比特流中哪里开始到哪里结束

#### 字符计数法

帧头部使用一个计数字段表明帧内字符数（包含自身占用的一个字节）  
计数字段出错即失去划分依据，收发双方失去同步

#### 字符填充的首尾定界符法

用特定字符定界一帧的开始与结束  
控制字符 SOH 表示首部开始，EOT 表示帧的结束  
为防止误判，信息位中出现的特殊字符前填充一个转义字符 ESC

#### 零比特填充的首尾标志法

01111110 标志一帧的开始与结束  
发送方在信息位中遇到 5 个连续的 1 即在后面插入一个 0  
接收方在信息位中遇到 5 个连续的 1 即删去后面的一个 0

容易由硬件实现，性能优于字符填充法

#### 违规编码法

利用编码方法中没有采用的编码序列定界帧的起始和终止（如曼彻斯特编码中的高-高和低-低）  
无需采用填充技术，只适用于采用冗余编码的环境  
例如：IEEE 802

较常用的是比特填充法和违规编码法

### 差错控制

#### 检错编码

1. 奇偶校验码
   : 奇/偶校验码的统称，由 $n-1$ 位信息元和 $1$ 位校验元组成

   加入校验元，使得 $n$ 元码字中 1 的个数为奇/偶  
   只能检测奇数位的出错情况，无法定位，无法纠错

2. 循环冗余码（Cyclic Redundancy Code, CRC）
   : 又称多项式码，由二进制数位串与只含 0/1 系数的多项式对应

   1. 发送方和接收方约定多项式 $G(x)$，最高位和最低位均为 1，次数为 $r$（即 $r+1$ 位二进制）
   2. 一个帧有 $m$ 位，低位加上 $r$ 个 0
   3. $G(x)$ 除处理后的数据串（模 2 除法），余数即冗余码（帧检验序列，FCS），共 $r$ 位
   4. 帧加上冗余码，共 $m+r$ 位，发送至接收方
   5. 接收方用 $G(x)$ 除收到的帧，若余数为 0 则认为无差错

   具有纠错功能，数据链路层仅使用了检错功能，出错则丢弃

#### 纠错编码（海明码）

例：$n=4$

1. $n$ 位信息位，$k$ 位校验位，需要满足

   $$ n+k\leq2^k-1 $$

   要检测两位错则需要再加一位校验位

2. 校验位 $P_i$ 在海明位号 $2^{i-1}$ 的位置上，其余为信息位

   $$
   H_7\ H_6\ H_5\ H_4\ H_3\ H_2\ H_1\\
   D_4\ D_3\ D_2\ P_3\ D_1\ P_2\ P_1
   $$

3. 每个信息位由多个校验位校验，信息位的海明位号等于校验位的海明位号之和

   - $D_1$ 由 $P_1P_2$ 校验
   - $D_2$ 由 $P_1P_3$ 校验
   - $D_3$ 由 $P_2P_3$ 校验
   - $D_4$ 由 $P_1P_2P_3$ 校验

4. 校验位的值为校验组（该校验位校验的所有信息位）求异或

   $$
   P_1=D_1\oplus D_2\oplus D_4\\
   P_2=D_1\oplus D_3\oplus D_4\\
   P_3=D_2\oplus D_3\oplus D_4
   $$

5. 每个校验位与其校验组求异或

   $$
   S_1=P_1\oplus D_1\oplus D_2\oplus D_4\\
   S_2=P_2\oplus D_1\oplus D_3\oplus D_4\\
   S_3=P_3\oplus D_2\oplus D_3\oplus D_4
   $$

   若 $S_3S_2S_1$ 为 000 说明无差错，否则就是错误位的位号，将该位取反

### 流量控制与可靠传输机制

1. 停止-等待流量控制：每发送一帧都要等待接收方的应答，才能发送下一帧。传输效率很低
2. 滑动窗口流量控制：发送方维持发送窗口，表示允许发送的帧；接收方维持接收窗口，表示允许接收的帧

   - 只有接收窗口向前滑动，发送窗口才可能向前滑动
   - 接收窗口大小为 1 可保证帧的有序接收
   - 数据链路层的滑动窗口协议中，窗口大小在传输过程中固定

3. 可靠传输机制

   - 确认：无数据的控制帧。可捎带在回复帧中，称为**捎带确认**，提高效率
   - 超时重传：发送帧后开启计时器，一定时间内未得到确认帧则重新发送

### 自动重传请求（Auto Repeat reQuest, ARQ）

#### 单帧滑动窗口与停止-等待协议

发送窗口 $W_\text{T}=1$，接收窗口 $W_\text{R}=1$

接收方每接收一帧都要反馈应答信号，发送方收到应答信号后才能发送下一帧  
发送方计时器满后仍未收到确认则再次发送相同的帧  
接收方收到同样的数据帧会丢弃，并重传对应的确认帧

- 帧交替使用 0 和 1 标识，对应确认使用 ACK0 和 ACK1。连续出现相同序号说明有重复帧
- 双方须设置帧缓冲区，保存数据帧的副本用于重传，收到确认帧后才可清除

传输效率低

#### 多帧滑动窗口协议与后退 $N$ 帧协议（GBN）

发送窗口 $W_\text{T}>1$，接收窗口 $W_\text{R}=1$

发送方可连续发送，接收方只允许按顺序接收  
接收方检测出失序，要求重传最后一个正确帧之后的所有帧  
发送方发现某一帧超时，重传该帧及之后的所有帧

确认帧需要指明对哪一帧进行确认  
可在连续收到几个正确数据帧后，对最后一个数据帧发送确认；或发送数据时捎带确认

用 $n$ 比特对帧编号，应满足 $1\leq W_\text{T}\leq2^n-1$

> 假设 $W_\text{T}=2^n$  
> 发送方发送 $2^n$ 个帧，编号 $0\sim2^n-1$，均被接收方接收，接收方发送确认帧。考虑以下两种情况：
>
> 1. 确认帧丢失，超时后发送方重传这 $2^n$ 个帧，编号 $0\sim2^n-1$
> 2. 发送方收到确认帧，之后发送 $2^n$ 个新的帧，编号同样是 $0\sim2^n-1$
>
> 此时接收方无法判断收到的是新的帧还是重传旧的帧

连续发送数据帧，提高信道利用率  
需要将正确发送的数据帧进行重传，降低传送效率

#### 多帧滑动窗口协议与选择重传协议（SR）

发送窗口 $W_\text{T}>1$，接收窗口 $W_\text{R}>1$，$W_\text{T}=W_\text{R}$

每个发送缓冲区对应一个计时器，用于超时重传  
接收方怀疑出错，发送否定帧 NAK，要求发送方重传指定的帧

避免重复传送本已正确到达的数据帧，但需要接收端设置缓冲区暂存未按序收到的帧  
落在窗口外的仍丢弃，因此缓冲区数目等于窗口大小

用 $n$ 比特对帧编号，应满足 $W_{\text{T}\max}=W_{\text{R}\max}=2^{n-1}\ (W_\text{T}+W_\text{R}\leq2^n)$

### 信道效率与信道吞吐率

- 信道效率（信道利用率）：一个发送周期时间内有效发送数据的时间占整个发送周期的比率
- 信道吞吐率：信道利用率 $\times$ 发送方的发送速率

### 介质访问控制（Medium Access Control, MAC）子层

多个结点共享广播信道时防止通信发生互相干扰

信道划分介质访问控制为静态划分方法，随机访问介质访问控制和轮询访问介质访问控制为动态分配方法

#### 信道划分介质访问控制

1. 频分多路复用（FDM）
   : 将多路基带信号调制到不同频率载波上。带宽总和不超过信道总带宽

   相邻信道之间加入保护频带，防止干扰  
   充分利用了传输介质的带宽，系统效率较高，实现较容易

2. 时分多路复用（TDM）
   : 将物理信道按时间分成若干时间片，轮流分配给多个信号使用

   统计时分多路复用（STDM）采用 STDM 帧，按需动态分配时隙，有数据需要传送时才分配时间片

3. 波分多路复用（WDM）
   : 光纤中传输多种不同波长的光信号，即光的频分多路复用

   光波处于高频段，带宽高，可实现多路波分复用

4. 码分多路复用（CDM）
   : 采用不同编码区分各路原始信号。码分多址（Code Division Multiple Access, CDMA）

   既共享频率，又共享时间

   1. 每个站点分配 $m$ 位码片序列（向量），各个站点码片序列相互正交
   2. 站点发送 1 时，发送其码片序列；发送 0 时，发送其码片序列的反码
   3. 多个站点同时发送时，数据在信道中线性相加
   4. 接收站点将所得向量与某站点的码片向量内积，即可过滤其他站点信息，得到该站点的数据

   频谱利用率高、抗干扰能力强、保密性强、语音质量好，可降低成本  
   主要用于无线通信系统，移动通信系统

#### 随机访问介质访问控制（争用型协议）

实质将广播信道转化为点到点信道

##### ALOHA（Additive Link On-line HAwaii）协议

- 纯 ALOHA 协议
  : 不经检测发送数据，若超时未收到确认，需要**等待一段随机时间**后再发送数据，直至发送成功

  设网络负载（$T_0$ 时间内发送的所有帧数）为 $G$，则网络吞吐量（$T_0$ 时间成功发送的平均帧数）为

  $$ S=Ge^{-2G} $$

  吞吐量很低

- 时隙 ALOHA 协议
  : 将时间划分为等长的时隙（Slot），时隙开始时刻才能发送帧，时隙长度保证每个帧在一个时隙内发送完毕。重传策略与纯 ALOHA 协议类似

  $$ S=Ge^{-G} $$

##### CSMA（Carrier Sense Multiple Access，载波侦听多路访问）协议

- 1-坚持 CSMA（1-persistent CSMA）
  : 发送前侦听信道，空闲则立即发送；信道忙则继续侦听。若发生冲突则随机等待一段时间后重新开始侦听

  传播延迟对该协议性能影响较大  
  多个结点可能同时检测到信道空闲并发送数据，造成冲突

- 非坚持 CSMA（Non-persistent CSMA）
  : 发送前侦听信道，空闲则立即发送；信道忙则放弃侦听，随机等待一段时间后重新开始侦听

  降低了冲突的概率  
  增加数据在网络中的平均延迟

- p-坚持 CSMA（P-persistent CSMA）
  : **适用于时隙信道**。发送前侦听信道，空闲则以概率 p 发送，概率 1-p 推迟至下一时隙；信道忙则推迟至下一时隙继续侦听

  降低多个结点同时发送数据造成冲突的概率  
  克服随机等待造成的延迟时间长

##### CSMA/CD（Collision Detection，碰撞检测）协议

用于总线型以太网，只能进行半双工通信

1. 发送前侦听信道，空闲则立即发送；信道忙则继续侦听
2. 发送过程中持续侦听，检测碰撞（电压变化），若产生碰撞则中止数据发送，并发送拥塞信号
3. 中止发送后执行指数退避算法

设单程传播时延为 $\tau$，站点在发送帧后至多经过时间 $2\tau$ 就能得知碰撞情况。称为**争用期**（冲突窗口、碰撞窗口）  
经过争用期还未检测到碰撞，可确定不会发生碰撞  
规定最小帧长为

$$ 2\tau\times\text{数据传输速率} $$

站点收到小于该长度的帧即为碰撞造成的无效数据，立即丢弃  
发送帧小于该长度时，需要在数据字段后加入填充字段，满足最小帧长

二进制指数退避算法：

1. 确定基本退避时间，一般取争用期 $2\tau$
2. $k=\min\{\text{重传次数},10\}$
3. 从整数 $\{0,1,\cdots,2^k-1\}$ 中随机取数 $r$，重传前退避时间 $2r\tau$
4. 重传次数超过 16，抛弃此帧，向高层报告出错

重传需要推迟的平均时间随重传次数增大而增大，降低碰撞发生的概率。又称动态退避

##### CSMA/CA（Collision Avoidance，碰撞避免）协议

用于无线局域网，由 802.11 规定

使用 ARQ 方案，每发送一帧都需确认。发送后须再等待一段很短的时间（持续监听），称为帧间间隔（InterFrame Space, IFS）

- SIFS（短 IFS）：最短，分隔属于一次会话的各帧。ACK 帧、CTS 帧、分片数据帧、回答 AP 探询的帧
- PIFS（点协调 IFS）：中等长，用于 PCF 操作
- DIFS（分布式协调 IFS）：最长，用于异步帧竞争访问

1. 最初发送数据，若信道空闲，等待 DIFS 后发送
2. 若信道忙，执行退避算法，且计时器仅在信道空闲时倒计时
3. 计时器减到 0（此时信道必空闲），发送帧并等待确认
4. 需要发送第二帧时先执行退避算法

:memo: 仅当信道空闲且发送第一个数据帧时不执行退避算法

隐蔽站：站点彼此听不见对方，同时发送数据导致碰撞

1. 发送站对信道进行预约，发送数据前广播请求发送 RTS（Request To Send）控制帧，包括源地址、目的地址、通信持续时间。RTS 可被 AP 在内的所有站点听到
2. 若信道空闲，AP 广播允许发送 CTS（Clear To Send）控制帧，包括通信持续时间。CTS 可被所有站点听到
3. 其他站听到 CTS，在指明的时间内抑制发送

RTS 和 CTS 很短，开销较小

#### 轮询访问介质访问控制：令牌传递协议

用于令牌环局域网，逻辑拓扑必须是环

令牌（Token）：特殊的 MAC 控制帧，沿环形总线在各结点计算机间依次传递

1. 网络空闲时，令牌在环路中循环传递
2. 发送数据时须等待令牌，修改令牌的标志位，附加传输的数据与目的地址，发送
3. 各站点对令牌进行转发，并查看目的地址。若与自己的地址相同则复制数据
4. 令牌回到源站点，不再转发。检验数据是否出错，若有则重传
5. 源站点传送完数据，重新产生一个令牌并传递

不会产生冲突  
适合高负载广播信道，即多个结点同时发送数据的概率较大的场合

### 局域网（Local Area Network, LAN）

1. 为一个单位所拥有，地理范围和站点数目有限
2. 所有站点共享较高的总带宽
3. 时延较低，误码率较低
4. 各站关系平等，非主从
5. 能进行广播和组播

三要素：

- 拓扑结构：星形结构、环形结构、总线形结构、星形和总线形结合的复合型结构
- 传输介质：双绞线、铜缆和光纤等，主流为双绞线
- 介质访问控制方法（最重要，决定局域网的技术特性）：CSMA/CD、令牌总线（总线形局域网）和令牌环（环形局域网）

特殊局域网拓扑：

- [以太网](#ieee-8023-以太网dix-ethernet-v2)（使用范围最广）：逻辑总线形，物理星形或拓展星形
- 令牌环（Token Ring, IEEE 802.5）：逻辑环形，物理星形
- FDDI（光纤分布数字接口，IEEE 802.8）：逻辑环形，物理双环

IEEE 802 标准中，局域网参考模型对应 OSI 的数据链路层和物理层，并将数据链路层拆分为逻辑链路控制（LLC）子层和媒体接入控制（MAC）子层

#### IEEE 802.3 以太网（DIX Ethernet V2）

基带总线形局域网标准，逻辑总线形，**广播通信**  
使用 [CSMA/CD](#csmacdcollision-detection碰撞检测协议) 进行访问控制

- 无连接，无确认，不对帧编号，尽最大努力交付。提供不可靠服务，纠错由高层完成
- 使用曼彻斯特编码，利用电压转换提取位同步信号

##### 以太网的传输介质与网卡

|     参数     |       10BASE5        |       10BASE2        |   10BASE-T   |    10BASE-FL    |
| :----------: | :------------------: | :------------------: | :----------: | :-------------: |
|   传输媒体   | 基带同轴电缆（粗缆） | 基带同轴电缆（细缆） | 非屏蔽双绞线 | 光纤对（850mm） |
|     编码     |     曼彻斯特编码     |     曼彻斯特编码     | 曼彻斯特编码 |  曼彻斯特编码   |
|   拓扑结构   |        总线形        |        总线形        |     星形     |     点对点      |
|   最大段长   |         500m         |         185m         |     100m     |      2000m      |
| 最多结点数目 |         100          |          30          |      2       |        2        |

网卡通过电缆或双绞线以串行方式与局域网通信，通过 I/O 总线以并行方式与计算机通信  
网卡实现物理连接和电信号匹配，完成帧的发送与接收、帧的封装与拆封、介质访问控制、数据编码与解码、数据缓存  
网卡工作在物理层，只关注比特

##### 以太网的 MAC 帧

网卡中的介质访问控制（MAC）地址也称物理地址  
6B，2 个十六进制数为一组，共 6 组  
xx-xx-xx-xx-xx-xx  
高 24 位为厂商代码，低 24 位为网卡序列号  
网卡收到 MAC 帧后首先检查帧中的 MAC 地址，若发往本站则接收

MAC 帧（DIX Ethernet V2）：

{ 前导码 8B | 目的地址 6B | 源地址 6B | 类型 2B | 数据 46-1500B | FCS 4B }

- 前导码：用于时钟同步。前 7B 为前同步码，快速实现 MAC 帧的比特同步；后 1B 为帧开始定界符
- 地址：MAC 地址
- 类型：指出数据应交给哪个协议实体处理
- 数据：由于 CSMA/CD 算法限制，以太网帧最小长度 64B，首部尾部共 18B，故数据最短为 46B，不足则需要填充。规定最大 1500B（MTU）
- 帧检验序列（FCS）：采用 32 位 CRC。需要校验目的地址、源地址、类型和数据字段，不校验前导码

:memo: 以太网在传送帧时各帧之间必须有一定间隙，因此 MAC 帧无需帧结束符（但仍需头部、尾部）

802.3 的帧格式中，类型域替换为长度域，指出数据域的长度

##### 高速以太网

速率 $\geq$ 100Mbps 的以太网

1. 100BASE-T 以太网

   - 双绞线
   - 100Mbps
   - 星形拓扑结构
   - 半双工，CSMA/CD
   - 全双工
   - 最大段长 100m，帧间间隔 0.96μs

2. 吉比特以太网（千兆以太网）

   - 1Gbps
   - 半双工，CSMA/CD
   - 全双工

3. 10 吉比特以太网

   - 光纤
   - 10Gbps
   - 仅使用全双工，无争用问题

#### IEEE 802.11 无线局域网

1. 有固定基础设施无线局域网

   802.11 系列协议，包括 802.11a/b/g/n 等。使用 802.11 协议的局域网又称 Wi-Fi  
   星形拓扑，中心称为接入点（Access Point, AP）  
   在 MAC 层使用 [CSMA/CA](#csmacacollision-avoidance碰撞避免协议) 协议

   基本服务集（Basic Service Set, BSS）
   : 无线局域网的最小构件，包括一个 AP 和若干移动站

   基本服务区（Basic Service Area, BSA）
   : BSS 覆盖的地理范围

   在本 BSS 内通信，或与外部站通信，都需通过本 BSS 的 AP（即基站）  
   安装 AP 时为其分配一个不超过 32 字节的服务集标识符（Service Set IDentifier, SSID）和一个信道。SSID 即该无线局域网的名字

   一个 BSS 可以孤立，也可以通过 AP 连接到一个分配系统（Distribution System, DS），并连接到另一个 BSS，构成一个扩展的服务集（Extended Service Set, ESS）  
   ESS 可通过 Portal（门户）为无线用户提供到有线连接的以太网接入，作用相当于网桥

2. 无固定基础设施移动自组织网络（自组网络，ad hoc network）

   没有 AP，由平等状态的移动站互相通信组成的临时网络  
   中间结点均为转发节点，都具有路由器的功能

   自组网络中的每个移动站都要参与网络中其他移动站的路由的发现和维护  
   网络拓扑可能随时间快速变化，因此固定网络中有效的一些路由选择协议对移动自组网络不适用

##### 802.11 局域网的 MAC 帧

三种类型：数据帧、控制帧、管理帧

数据帧：

{ MAC 首部 30B | 帧主体（数据部分）0-2312B | FCS 4B }

首部中包含 4 个地址字段（MAC 地址）  
首部 - 帧控制字段中包含去往 AP 和来自 AP 字段

- 地址 1：**直接接收**数据帧的结点地址
- 地址 2：**实际发送**数据帧的结点地址
- 地址 3：允许 AP 在构建以太网帧时确定目的 MAC 地址
- 地址 4：用于自组网络

如在一个 BSS 中，A $\to$ AP $\to$ B

|            | 去往 AP | 来自 AP | 地址 1 | 地址 2 | 地址 3 |
| :--------: | :-----: | :-----: | :----: | :----: | :----: |
| A $\to$ AP |    1    |    0    |   AP   |   A    |   B    |
| AP $\to$ B |    0    |    1    |   B    |   AP   |   A    |

#### 虚拟局域网（Virtual LAN, VLAN）

把一个较大的局域网分割成小的、与地理位置无关的逻辑上的 VLAN，较小的广播域

VLAN 标签
: 802.3ac 定义[以太网帧](#以太网的-mac-帧)格式的扩展，在源地址与类型字段之间插入 4B 的标签。指明了发送的计算机所属的 VLAN

802.1Q 帧
: 插入了 VLAN 标签的以太网帧

VLAN 标签：

- 前 2 个字节：0x8100。表示该帧为 802.1Q 帧
- 后 2 个字节：前 4 位没用，后 12 位为所属 VLAN 的标识符 VID。可识别 4096 个不同的 VLAN

插入 VLAN 标签后，FCS 须重新计算

### 广域网

覆盖范围很广的长距离网络，是因特网的核心部分  
各结点交换机的链路是高速链路  
首要考虑通信容量必须足够大

互联网可以连接不同类型的网络，使用路由器连接；广域网由结点交换机和连接这些交换机的链路组成  
结点之间点到点连接，一个结点交换机往往与多个结点交换机相连

:memo: 结点交换机在单个网络中转发分组，路由器在多个网络构成的互联网中转发分组

#### PPP 协议（Point-to-Point Protocol）

串行线路通信，面向字节

组成部分：

1. 链路控制协议（LCP）：一种扩展链路控制协议，用于建立、配置、测试和管理数据链路
2. 网络控制协议（NCP）：PPP 协议允许同时采用多种网络层协议，每个不同的网络层协议用一个相应的 NCP 进行配置，为网络层协议建立和配置逻辑连接
3. 一个将 IP 数据报封装到串行链路的方法：PPP 帧的信息部分即 IP 数据报，长度受最大传送单元（MTU）限制

PPP 帧：

{ 标志 1B | 地址 1B | 控制 1B | 协议 2B | 信息 0-1500B | FCS 2B | 标志 1B }

- 标志字段（F）：0x7E，转义字节为 0x7D
- 地址字段（A）：0xFF
- 控制字段（C）：0x03
- 协议：指明信息部分运载的分组种类。以 0 开始的是 IP、IPX、AppleTalk 等网络层协议，以 1 开始的用于协商其他协议。0x0021 表示 IP 数据报
- 信息部分：出现与标志字段相同的组合时需要转义
- 帧检验序列（FCS）：CRC。校验地址字段、控制字段、协议字段、信息字段

:memo: PPP 点对点，不是总线型，无需 CSMA/CD，无最短帧限制

使用 CRC 检错，不纠错  
不可靠传输，不使用序号和确认机制  
仅支持点对点，不支持多点  
仅支持全双工  
两端可运行不同的网络层协议，仍用同一个 PPP 通信  
异步线路上采用[字节填充](#字符填充的首尾定界符法)，SONET/SDH 等同步线路上采用[比特填充](#零比特填充的首尾标志法)

#### HDLC（High-level Data Link Control，高级数据链路控制）协议

面向比特

HDLC 帧：

{ 标志 8b | 地址 8b | 控制 8b | 信息 可变 | FCS 16b | 标志 8b }

- 标志字段（F）：01111110
- 地址字段（A）：根据不同的传送方式，表示从站或应答站的地址
- 控制字段（C）：实现许多重要功能
- 帧检验序列（FCS）：CRC。校验地址字段、控制字段、信息字段

不依赖于字符编码集  
数据报文可透明传输，采用 [0 比特插入法](#零比特填充的首尾标志法)  
全双工通信  
采用 CRC 校验，使用编号和确认机制，可靠性高  
传输控制功能与处理功能分离，灵活性强

### 数据链路层设备

#### 网桥

工作在 MAC 子层  
具有路径选择功能

多个以太网通过网桥连接，成为范围更大的以太网  
原来的每个以太网称为一个网段，各网段是隔离开的碰撞域（冲突域）  
网段故障不会影响其他网段

:memo: 网段内传输无需网桥转发

#### 局域网交换机（以太网交换机）

多端口的网桥，将网络分成小的冲突域  
可用于实现 VLAN

特点：

- 每个端口直接与单台主机相连，全双工
- 能同时连接多对端口，每对主机可独占式无碰撞通信
- 即插即用，转发表动态更新建立，无需人工配置
- 使用专用的交换结构芯片，交换速率较高
- 独占传输媒体的带宽

交换模式：

1. 直通式交换机
   : 只检查帧的目的地址，直接发送

   :+1: 速度快  
   :-1: 缺乏智能性和安全性，不支持不同速率的端口

2. 存储转发式交换机
   : 接收到的帧放入高速缓存，并检查是否正确。确认无误则发送；有错则丢弃

   :+1: 可靠性高，支持不同速率端口的转换  
   :-1: 延迟较大

##### 交换机的自学习功能

过滤：决定一个帧应该转发还是丢弃  
转发：决定一个帧应该移动至哪个接口

过滤和转发借助交换表（switch table）完成

交换表表项：

{ MAC 地址 | 连通该地址的交换机接口 }

1. 交换表初始为空
2. 收到帧，将源地址与对应的接口写入交换表
3. 转发时查找交换表，若目的地址的表项存在，则从对应接口发送
4. 若目的地址表项不存在，则向所有接口（输入接口除外）广播该帧。此时目标主机接收该帧，其余主机将其丢弃
5. 所连主机随时可能变化，因此每个表项设有有效时间，过期即自动删除

## 网络层

### 网络层的功能

#### 异构网络互联

将两个以上的计算机网络使用中间设备（中继系统）互相连接  
通常指使用路由器进行网络互联和路由选择  
物理层和数据链路层的中继系统仅在一个网络内进行扩大

网络层采用标准化协议，连接异构的网络，互联后的网络可视为虚拟 IP 网络

#### 路由与转发

1. 路由选择
2. 分组转发

路由表根据路由选择算法得出，转发表根据路由表得出

#### 软件定义网络（SDN）

采用集中式的控制层面和分布式的数据层面，两个层面互相分离  
控制层面对数据层面的路由器进行集中控制，计算最佳路由，下发转发表；路由器仅负责分组转发

:+1:

1. 利于控制层面全局优化，高性能的网络转发
2. 灵活可编程与性能平衡
3. 降低成本，网络设备制造与功能软件开发相分离

:-1:

1. 集中管理易受攻击，存在安全风险
2. 控制器可能成为网络性能的瓶颈

#### 拥塞控制

拥塞：通信子网中出现过量分组导致网络性能下降  
网络的吞吐量随网络负载的增加而下降

1. 开环控制
   : 设计网络时事先考虑有关因素，力求网络工作时不产生拥塞

   静态预防方法，系统运行后便无需修改  
   确定何时可接受新流量、丢弃分组及丢弃哪些分组、确定调度策略等  
   做决定时不考虑当前网络的状态

2. 闭环控制
   : 事先不考虑因素，使用监测系统监视网络，检测拥塞信息并调整运行

   动态方法，基于反馈环路

### 路由算法

1. 静态路由算法（非自适应路由算法）
   : 网络管理员手工配置路由信息，网络结构或状态发生改变时需要手工修改

   :+1: 简便，开销小  
   :-1: 不能及时适应网络状态的变化

   应用于简单的小型网络

2. 动态路由算法（自适应路由算法）
   : 路由表项通过路由器之间交换信息，按一定算法优化得到，并随网络变化不断更新

   :+1: 改善网络性能，有助于流量控制  
   :-1: 算法会增加网络的负担；对变化的反应太快会引起振荡，太慢则影响路由的一致性

#### 距离-向量路由算法

路由选择表包含

- 每条路径的目的地（另一结点）
- 路径的代价（距离）

1. 所有结点定期将整个路由选择表传送给**直接相邻**的结点
2. 若被通告一条新的路由，将其加入本地的表中
3. 若有一条到达某结点的路由距离更短，将其替换

更新报文的大小与通信子网的规模成正比  
有可能遇到路由环路等问题

常见算法如 [RIP 算法](#路由信息协议routing-information-protocol-rip)

#### 链路状态路由算法

每个结点具有完全的网络拓扑信息

1. 结点主动测试所有邻接结点的状态
2. 定期将链路状态传播给**所有其他结点**
3. 接收到链路状态后更新网络拓扑信息，发生变化时利用 [Dijkstra 算法](./DataStructure.md#dijkstra-算法)计算最短路由

- 使用洪泛法发送信息
- 发送的信息包括相邻结点及链路的度量
- 仅当链路状态发生变化时才发送信息

结点在本地独立计算路径  
更新报文仅包含直接链路的信息，与网络结点数目无关  
相比距离-向量路由算法有更好的规模可伸展性

[OSPF 算法](#开放最短路径优先ospf协议)

### IPv4

#### IPv4 分组

<table>
<thead align="left">
  <tr>
    <th width="12.5%">0</th>
    <th width="12.5%">4</th>
    <th width="25%">8</th>
    <th width="9.375%">16</th>
    <th colspan="2" width="40.625%">19</th>
  </tr>
</thead>
<tbody align="center">
  <tr>
    <td width="12.5%">版本</td>
    <td width="12.5%">首部长度</td>
    <td width="25%">区分服务</td>
    <td colspan="3" width="50%">总长度</td>
  </tr>
  <tr>
    <td colspan="3" width="50%">标识</td>
    <td width="9.375%">标志</td>
    <td colspan="2" width="40.625%">片偏移</td>
  </tr>
  <tr>
    <td colspan="2" width="25%">生存时间</td>
    <td width="25%">协议</td>
    <td colspan="3" width="50%">首部校验和</td>
  </tr>
  <tr>
    <td colspan="6">源地址</td>
  </tr>
  <tr>
    <td colspan="6">目的地址</td>
  </tr>
  <tr>
    <td colspan="5" width="75%">可选字段（长度可变）</td>
    <td width="25%">填充</td>
  </tr>
  <tr>
    <td colspan="6">数据部分</td>
  </tr>
</tbody>
</table>

- 版本：IP 协议的版本
- 首部长度：最大值为 15，单位为 4B，即 60B。首部固定部分为 20B，之后为可选字段
- 总长度：首部与数据长度之和，单位为 1B。封装成帧时不超过数据链路层的最大传送单元（MTU）
- 标识：计数器，每产生一个数据报就加 1。一个数据报的分片有相同的标识号
- 标志：最低位 $\text{MF}=1$ 表示还有分片，中间位 $\text{DF}=0$ 表示允许分片
- 片偏移：分片在原分组中的相对位置，单位为 8B。故分片的长度一定为 8B 的整数倍（最后一个分片除外）
- 生存时间（TTL）：可通过的最大路由器数量。路由器转发前将 TTL 减 1，若 TTL 为 0 则丢弃
- 协议：6 表示 TCP，17 表示 UDP
- 首部校验和：只校验首部
- 源地址/目的地址：均为 IP 地址

##### IP 数据报分片

IP 数据报总长度超过 MTU 时，需要分片，在目的地的网络层重新组装  
片具有与原始数据报相同的标识号

- MF（More Fragment）：1 表示还有后续分片，0 表示最后一片
- DF（Don't Fragment）：0 表示允许分片

利用片偏移字段确定位置，完成重组

#### IPv4 地址

32 位  
{<网络号>, <主机号>}

- A 类：网络号 8 位。1 ~ 126（0XXX）
- B 类：网络号 16 位。128.0 ~ 191.255（10XX）
- C 类：网络号 24 位。192.0.0 ~ 223.255.255（110X）
- D 类：多播地址。224 ~ 239（1110）
- E 类：保留。240 ~ 255（1111）

特殊 IP 地址：

- 主机号全为 0：表示本网络本身
- 主机号全为 1：本网络的广播地址，直接广播地址
- 127.X.X.X：环回自检（Loopback Test）地址，表示任意主机本身。该目的地址的 IP 数据报不会出现在网络上
- 0.0.0.0：表示本网络上的本主机
- 255.255.255.255：整个 TCP/IP 网络的广播地址，受限广播地址。由于路由器隔离广播域，等效为本网络的广播地址
- 网络号全为 0：表示本网络

1. IP 地址管理机构只分配网络号，主机号由单位自行分配
2. 路由器仅根据网络号转发分组，减小了路由表所占的空间
3. 主机同时连接至不同网络，同时具有相应 IP 地址，且网络号不同。故路由器至少具有两个 IP 地址
4. 转发器或桥接器（网桥等）连接的 LAN 仍是同一个网络（广播域），故网络号相同
5. IP 地址中，所有网络平等

#### 网络地址转换（NAT）

将专用网络地址转换为公用地址，对外隐藏内部的 IP 地址  
本地 IP 可重用，减少了 IP 地址消耗

私有 IP 地址（可重用地址）网段：

- A 类：1 个，10
- B 类：16 个，172.16 ~ 172.31
- C 类：256 个，192.168.0 ~ 192.168.255

对于目的地址为私有地址的数据报，路由器不进行转发  
路由器安装 NAT 软件，至少有一个有效的公用 IP 地址，使用 NAT 转换表进行地址转换

NAT 转换表：{本地 IP : 端口} - {全球 IP : 端口}

#### 子网划分

从主机号借用若干比特作为子网号  
{<网络号>, <子网号>, <主机号>}

子网掩码：32 位，1 对应网络号及子网号，0 对应主机号。和 IP 地址进行逐位与运算即可得到子网的网络地址

路由表中每个条目需要给出网络的子网掩码  
路由器互相交换信息时需要包括子网掩码

##### 无分类域间路由选择（CIDR）

使用变长子网掩码，消除传统 A、B、C 类网络划分  
{<网络前缀>, <主机号>}

CIDR 记法（斜线记法）：IP 地址/网络前缀位数

路由聚合（构成超网）：网络前缀相同的连续 IP 地址组成 CIDR 地址块  
若路由器中不同的网络具有相同的前缀和下一跳地址，则可进行路由聚合，减少路由器之间的信息交换

最长前缀匹配（最佳匹配）：查找路由表时若有多个匹配，选择**网络前缀最长**的路由，即最具体的路由  
CIDR 的路由表通常存放在层次式数据结构中，自上而下按层查找。常用二叉线索树

##### 转发分组的过程

转发表中每条路由包括目的网络、下一跳地址  
为实现最长前缀匹配，可将表项按前缀长度降序排列

特殊的路由：

- 主机路由：对特定主机的 IP 专门指明路由，此时的掩码可用 /32 表示
- 默认路由：用 0.0.0.0/0 表示默认路由，目的网络不在表中则一律选择默认路由

1. 收到 IP 分组，从首部提取目的主机地址
2. 若查找到特定主机路由，则按下一跳转发分组；否则从表中下一项开始查找
3. 表项的掩码和目的地址按位与，若与该项网络前缀匹配，则按下一跳转发
4. 若存在默认路由，传送至默认路由；否则报告转发出错

:memo: 得到下一跳路由器的 IP 后，通过 ARP 将 IP 转换为 MAC 地址，放入 MAC 帧首部，据此找到下一跳路由器

#### ARP、DHCP 与 ICMP

##### 地址解析协议（Address Resolution Protocol, ARP）

每台主机设有 ARP 高速缓存，存放各主机和路由器的 IP 地址到 MAC 地址的映射，称为 ARP 表

1. 源主机向本局域网上的某主机（或路由器）发送 IP 数据报，先在 ARP 缓存中查看是否有该地址
2. 如有，则将对应硬件地址写入 MAC 帧并发送；如没有，使用目的 MAC 地址为 FF-FF-FF-FF-FF-FF 的帧封装并广播 ARP 请求分组
3. 同一局域网中所有主机收到 ARP 请求，目标主机发出 ARP 响应分组（单播），包含自身 IP 地址与 MAC 地址的映射关系
4. 源主机收到响应分组，将映射关系写入 ARP 缓存，并发送数据报

:memo: ARP 用于解决**同一个局域网**上 IP 与 MAC 地址的映射问题。若不在同一个局域网，则通过 ARP 将分组发送至路由器，并进行转发

##### 动态主机配置协议（Dynamic Host Configuration Protocol, DHCP）

用于动态分配 IP 地址  
应用层协议，基于 UDP，使用 C/S 模式

1. DHCP 客户机广播 DHCP 发现消息。源地址 0.0.0.0，目的地址 255.255.255.255
2. DHCP 服务器收到 DHCP 发现消息，广播 DHCP 提供消息，包括提供的 IP 地址。目的地址 255.255.255.255
3. 客户机收到 DHCP 提供消息，若接受该 IP，广播 DHCP 请求消息。源地址 0.0.0.0，目的地址 255.255.255.255
4. 服务器广播 DHCP 确认消息，将 IP 地址分配给客户机。目的地址 255.255.255.255

- 配置了多台 DHCP 服务器时，客户机只挑选最先应答的
- IP 地址分配是临时的，称为租用期
- 执行期间客户端未被分配 IP 地址，故只能广播通信，采用无连接的 UDP

##### 网际控制报文协议（Internet Control Message Protocol, ICMP）

用于报告差错和异常情况  
网络层协议

- ICMP 差错报告报文

  1. 终点不可达：不能交付数据报
  2. 源点抑制：由于拥塞丢弃数据报
  3. 时间超过：收到生存时间（TTL）为零的数据报；规定时间内无法收到所有数据报片
  4. 参数问题：数据报首部中有字段值不正确
  5. 改变路由（重定向）：让主机知道下次发送给另外的路由器（有更好的路由）

  - 对 ICMP 差错报告报文不发送 ICMP 差错报告报文
  - 对第一个分片的所有后续分片不发送 ICMP 差错报告报文
  - 具有组播地址的不发送 ICMP 差错报告报文
  - 具有特殊地址的不发送 ICMP 差错报告报文

- ICMP 询问报文

  1. 回送请求和回答报文
  2. 时间戳请求和回答报文
  3. 地址掩码请求和回答报文
  4. 路由器询问和通告报文

应用于 PING（回送请求和回答报文）和 Traceroute（时间超过报文）

### IPv6

- 更大的地址空间
- 扩展的地址层次结构
- 灵活的首部格式
- 简化分组头，包含 8 个域
- 改进的选项，加快分组的处理速度
- 允许协议继续扩充
- 支持即插即用（自动配置）
- 支持资源预分配
- 只在包的源结点才能分片，不允许路由分片
- 首部长度是 8B 的整数倍
- 增大安全性，具有身份验证和保密功能

#### IPv6 地址

- 单播：点对点
- 多播：一对多
- 任播：目的站为一组计算机，只需交付其中一台（通常为距离最近）

IPv6 地址为 128 位，4 个十六进制数为一组，共 8 组

分级：

1. 第一级（顶级）：全球公共拓扑
2. 第二级（场点级）：单个场点
3. 第三级：单个网络接口

过渡策略：

- 双协议栈
  : 一台设备同时装有 IPv4 和 IPv6 协议栈
- 隧道技术
  : 将 IPv6 数据报封装到 IPv4 数据报的数据部分，在 IPv4 网络中传输

### 路由协议

#### 自治系统（Autonomous System, AS）

单一技术管理下的一组路由器  
使用一种 AS 内部的路由选择协议和共同的度量确定 AS 内的路由  
使用一种 AS 之间的路由选择协议确定 AS 之间的路由

一个 AS 的所有路由器在该 AS 内连通

#### 层次路由

互联网划分为较小的自治系统，自治系统内包含许多局域网

1. 内部网关协议（Interior Gateway Protocol, IGP）
   : 自治系统内部使用的路由选择协议，也称域内路由选择。如 [RIP](#路由信息协议routing-information-protocol-rip)、[OSPF](#开放最短路径优先ospf协议)
2. 外部网关协议（External Gateway Protocol, EGP）
   : 自治系统之间使用的路由选择协议，也称域间路由选择。如 [BGP-4](#边界网关协议border-gateway-protocol-bgp)

:memo: OSPF 可将一个 AS 划分为若干区域（Area），每个路由器仅知道所在区域内的路由细节

#### 路由信息协议（Routing Information Protocol, RIP）

应用层协议，使用 UDP（端口 520）

- 每个路由器维护从自身到所有目的网络的距离记录（距离向量）
- 距离由跳数（Hop Count）衡量，最多允许 15 跳，16 跳即表示网络不可达（防止在环路上循环）
- 每 30 秒在相邻路由器之间广播一次 RIP 路由更新信息
- 不支持子网掩码广播，每个网络的子网掩码必须相同。RIP2 支持变长子网掩码和 CIDR

路由表项：<目的网络 $N$, 距离 $d$, 下一跳地址 $X$>

1. 收到相邻路由器 $X$ 的 RIP 报文，将其表项的下一跳地址均改为 $X$，距离均 $+1$
2. 对修改后的每个表项

   - 若自身路由表中没有 $N$，将该项加入路由表
   - 若路由表中有 $N$，且下一跳地址是 $X$，将该项替换原表项
   - 若路由表中有 $N$，且下一跳地址不是 $X$，若收到的表项距离 $d$ 更小，则替换原表项

3. 若 180 秒未收到相邻路由器的更新报文，将其记为不可达（即距离设为 16）

:+1: 实现简单、开销小、收敛较快  
:-1:

1. 最大跳数限制了网络规模
2. 交换完整路由表，因此开销随着网络规模的增大而增大
3. 网络出现故障时，需要较长时间传送该信息，出现慢收敛

#### 开放最短路径优先（OSPF）协议

网络层协议，使用 IP 数据报传送（协议字段 89）

- 向本 AS 中的所有路由器发送信息，使用洪泛法
- 发送的信息为所有**相邻路由器**的链路状态，包括路由器及其链路代价
- 仅当链路状态发生变化时才发送信息

1. 每个路由器可建立链路状态数据库，即全网的拓扑结构图，在全网范围内一致
2. 使用 Dijkstra 算法计算从自身到各目的网络的最短路径，构造自己的路由表
3. 链路状态发生变化时，重新计算最短路径

:memo: 路由表中仅存储下一跳

将 AS 划分为较小的区域，洪泛法的通信量更小

- 根据 IP 的不同服务类型（TOS），可设置不同代价，因此对不同类型的业务可计算出不同路由
- 存在多条代价相同的路径，可将通信量分配给这些路径，实现多路径间的负载平衡
- 分组具有鉴别功能，仅在可信赖的路由器之间交换
- 支持可变长子网划分、CIDR
- 每个链路状态带有 32 位的序号，序号越大状态越新

分组类型：

1. 问候分组
   : 发现和维持邻站的可达性

   每隔 10 秒，相邻路由器之间交换一次问候分组，获知哪些站可达

2. 数据库描述分组
   : 向邻站给出自己链路状态数据库中所有项目的摘要信息

   路由器刚开始工作时，相邻路由器之间交换数据库描述分组

3. 链路状态请求分组
   : 向对方请求发送某些链路状态项目的详细信息

   交换数据库描述分组后，向对方请求发送自己缺少的项目的详细信息

4. 链路状态更新分组
   : 用洪泛法对全网更新链路状态

   链路状态发生改变时，向全网更新链路状态

5. 链路状态确认分组
   : 对链路更新分组的确认

   收到更新分组后发送确认分组

每隔一段时间（如 30 分钟）刷新一次数据库的链路状态

:+1: 网络规模很大时具有较好的性能，没有坏消息传得慢的问题

#### 边界网关协议（Border Gateway Protocol, BGP）

不同 AS 的路由器之间交换路由信息的协议  
寻找最佳路由不现实，只能力求寻找一条可达且较好的路由  
采用**路径向量**路由选择协议  
应用层协议，基于 TCP

1. 每个 AS 的管理员选择至少一个（可多个）路由器作为该 AS 的 BGP 发言人
2. 不同 AS 的 BGP 发言人之间建立 TCP 连接，交换 BGP 报文以建立 BGP 会话
3. 利用 BGP 会话交换路由信息，即到达某个网络需要经过的一系列 AS
4. 所有 BGP 发言人互相交换信息后，即可找出到达各 AS 的较好路由

- BGP 发言人还需要运行该 AS 的内部网关协议
- 交换路由信息的结点数量级即 AS 的数量级
- 每个 AS 的 BGP 发言人数目很少，路由选择不致过分复杂
- BGP 支持 CIDR，因此路由表包括目的网络前缀、下一跳路由器、需要经过的路由器序列
- BGP 开始运行时，相邻站点交换路由表。后续只在发生变化时更新有变化的部分

报文类型：

1. 打开（Open）报文
   : 与相邻 BGP 发言人建立关系
2. 更新（Update）报文
   : 发送某一路由信息，列出需要撤销的路由
3. 保活（Keepalive）报文
   : 确认打开报文，周期性证实邻站关系
4. 通知（Notification）报文
   : 发送检测到的差错

### IP 组播

仅应用于 UDP  
源主机将单个分组发送至一个组播地址，网络将分组的副本投递给组中的每台主机  
一台主机可同时属于多个组

主机通过因特网组管理协议（IGMP）加入组播组，通知路由器接收发送至该组播组的分组  
组播需要路由器支持（组播路由器），在传送路径出现分岔时将分组复制后转发

#### IP 组播地址

IPv4 用 D 类地址作为组播地址  
组播数据报的目的地址为组播地址，协议字段为 2（表示 IGMP）

- 组播数据报尽最大努力交付，不提供可靠交付
- 组播地址不可用于源地址
- 组播数据报不产生 ICMP 差错报文
- 并非所有 D 类地址都可作为组播地址

硬件组播：

在局域网中，组播数据报以硬件组播方式交付给组播组

以太网组播地址范围：01-00-5E-00-00-00 到 01-00-5E-7F-FF-FF，即 23 位可用  
D 类 IP 后 23 位即对应其硬件组播地址  
IP 组播地址与以太网组播地址的映射关系不唯一，因此主机还要在 IP 层利用软件进行过滤

#### IGMP 与组播路由算法

因特网组管理协议（Internet Group Management Protocol, IGMP）

1. 主机加入新的组播组，向该组播组的组播地址发送 IGMP 报文
2. 本地组播路由器收到 IGMP 报文，将组成员关系传发给因特网上其他组播路由器
3. 本地组播路由器周期性探询本地局域网上的主机，确认是否仍是组的成员
4. 某个组只要有一台主机响应，即认为该组是活跃的；若几次探询后没有一台主机响应，则不再转发该组的成员关系

组播路由选择协议

- 找出以源主机为根结点的组播转发树，每个分组在每条链路上只传送一次
- 三种路由算法：基于链路状态的路由选择、基于距离-向量的路由选择、协议无关的组播（PIM）（可建立在任何路由器协议上）

### 移动 IP

移动结点以固定的网络 IP 实现跨越不同网段的漫游功能  
基于网络 IP 的网络权限在漫游过程中不发生改变  
移动结点在不改变 IP 地址的情况下改变驻留位置，分组自动投递给移动结点

三种功能实体：

- 移动结点
  : 具有永久 IP 地址的移动结点
- 归属代理（本地代理）
  : 移动结点的归属网络中，代表移动结点执行移动管理功能的实体。根据移动用户的转交地址，采用隧道技术转交数据包
- 外埠代理（外部代理）
  : 外部网络中帮助移动结点完成移动管理功能的实体

转交地址：用于标识移动结点现在所处的位置  
移动结点的本地地址和转交地址的联合称为**移动绑定**（绑定）  
移动结点得到新的转交地址时，通过绑定向本地代理进行注册

1. 移动结点在本地网，按传统 TCP/IP 方式通信
2. 移动结点漫游到外地网络，使用固定 IP 地址进行通信。向本地代理注册当前位置地址（即转交地址）
3. 本地代理接收注册，构建通向转交地址的隧道，发给移动结点的分组通过隧道送至转交地址
4. 转交地址处解除隧道封装，恢复 IP 分组，送至移动结点
5. 移动结点在外网通过外网的路由器或外部代理发送 IP 数据包
6. 移动结点来到另一个外网，向本地代理更新转交地址
7. 移动结点回到本地网，向本地代理注销转交地址

### 网络层设备

#### 冲突域

连接到同一物理介质上的所有结点的集合  
存在介质争用现象

集线器、中继器属于同一个冲突域（1 层）  
网桥、交换机、路由器可划分冲突域（2、3 层）

#### 广播域

接收同样广播消息的结点集合

集线器、交换机等属于同一个广播域（1、2 层）  
路由器可划分广播域（3 层）

#### 路由器

具有多个输入/输出端口  
连接不同网络（异构网络），完成路由转发  
互联多个广播域必须使用路由器

- 路由选择部分（控制部分）：路由选择处理机根据所选路由选择协议构造路由表，定期更新维护
- 分组转发部分

  - 交换结构：根据转发表处理分组，选择合适端口进行转发。通过存储器/总线/互联网络进行交换
  - 输入端口：比特流 $\to$ 帧 $\to$ 数据报
  - 输出端口：数据报 $\to$ 帧 $\to$ 比特流

1. 分组转发
2. 路由计算

:memo: 网桥与高层协议无关，路由器面向协议

#### 路由表与路由转发

路由表项：{ 目的网络 IP 地址 | 子网掩码 | 下一跳 IP 地址 | 接口 }  
转发表由路由表得出，含有目的地址、下一跳地址（MAC 地址）  
路由表对网络拓扑变化的计算最优化；转发表对查找过程最优化  
可使用默认路由代替所有具有相同下一跳的项，并设置最低优先级

路由表由软件实现，转发表可由软件或特殊硬件实现

:memo: 分组转发直接查找转发表，而非查找路由表

## 传输层

1. 为不同主机上的进程之间提供逻辑通信（即端到端的通信）
2. 复用和分用：发送方的不同应用进程可使用同一个传输层协议；接收方的传输层可将数据正确交付到目的应用进程
3. 对收到的报文进行差错检测（首部和数据）
4. 可同时实现 TCP 和 UDP 两种协议

### 传输层寻址与端口

数据链路层的 SAP：MAC 地址  
网络层的 SAP：IP 地址  
传输层的 SAP：端口（软件端口）

端口标识主机中的应用进程

#### 端口号

长度 16 位  
只具有本地意义

1. 服务器端使用的端口号

   - 熟知端口号：0 ~ 1023。由 IANA 指派给最重要的应用程序

     |  FTP  | TELNET | SMTP  |  DNS  | TFTP  | HTTP  | SNMP  |
     | :---: | :----: | :---: | :---: | :---: | :---: | :---: |
     |  21   |   23   |  25   |  53   |  69   |  80   |  161  |

   - 登记端口号：1024 ~ 49151。供没有熟知端口号的应用程序使用，须在 IANA 登记

2. 客户端使用的端口号：49152 ~ 65535。仅在客户进程运行时动态选择，又称短暂端口号（临时端口）

:memo: 默认端口号通常指服务器端；客户端端口号通常为动态分配

#### 套接字

套接字 Socket (IP 地址: 端口号)  
唯一标识网络上的一台主机和其上的一个应用进程  
报文段包含端口号

#### 无连接服务与面向连接服务

- TCP：面向连接。FTP、HTTP、TELNET
- UDP：无连接。TFTP、DNS、SNMP、RTP

### UDP 协议（User Datagram Protocol）

UDP 在 IP 之上增加的服务：复用和分用、差错检测

1. 无需建立连接，时延更小
2. 无连接状态，无需对连接状态进行维护
3. 分组首部开销更小
4. 应用层能更好地控制要发送的数据和发送时间
5. 支持一对一、一对多、多对一、多对多

应用：

- 一次性传输较少数据的网络应用：连接的建立、维护等带来较大开销
- 多媒体应用（实时视频、流媒体等）：可容忍数据丢失，不允许较大时延

不保证可靠交付  
面向报文，不分片

#### UDP 数据报

<table>
<thead align="left">
  <tr>
    <th width="50%">0</th>
    <th width="50%">16</th>
  </tr>
</thead>
<tbody align="center">
  <tr>
    <td width="50%">源端口号</td>
    <td width="50%">目的端口号</td>
  </tr>
  <tr>
    <td width="50%">UDP 长度</td>
    <td width="50%">UDP 校验和</td>
  </tr>
  <tr>
    <td colspan="2">数据</td>
  </tr>
</tbody>
</table>

- 源端口：需要对方回信时选用，不需要时可置 0
- 目的端口：用于交付报文
- 长度：首部和数据的总长度，最小值为 8B（首部长度）
- 校验和：校验首部和数据，若传输中产生错误则丢弃。可选字段，源主机不想校验时可置 0

接收方发现目的端口号不正确（即该端口号的应用进程不存在），则丢弃报文，并由 ICMP 发送端口不可达差错报文

#### UDP 校验

计算校验和时需要在 UDP 数据报前添加 12B 的伪首部  
伪首部不进行传送，仅用作计算校验和  
校验时检查首部和数据部分

伪首部内容：{ 源 IP 地址 4B | 目的 IP 地址 4B | 0 | 17 | UDP 长度 2B }

校验过程：

1. 校验和字段置 0，添加伪首部
2. 若数据报不是偶数字节，填充一个全 0 字节（该字节不发送）
3. 每 16 位视为一个数，按二进制反码运算求和，所得的和写入校验和字段
4. 接收方按上述规则进行二进制反码运算求和
5. 若结果为 0，说明无差错，否则就丢弃数据报（或交付给上层并报告错误）

:memo: 二进制反码运算求和：若最高位进位，则在最低位进 1。求和后取反

:+1: 添加伪首部使得可同时检查 IP 地址；简单、处理速度快  
:-1: 校错能力不强

### TCP 协议 （Transmission Control Protocol）

解决传输可靠、有序、无丢失、不重复问题

1. 面向连接，TCP 连接是一条逻辑连接
2. 每条连接仅有两个端点，端到端（进程对进程）
3. 全双工通信，两端均设有发送缓存和接收缓存
4. 面向字节流。TCP 将应用程序交下的数据视为无结构字节流

#### TCP 报文段

<table>
<thead align="left">
  <tr>
    <th width="12.5%">0</th>
    <th width="18.75%">4</th>
    <th width="3.125%">10</th>
    <th width="3.125%">11</th>
    <th width="3.125%">12</th>
    <th width="3.125%">13</th>
    <th width="3.125%">14</th>
    <th width="3.125%">15</th>
    <th colspan="2" width="50%">16</th>
  </tr>
</thead>
<tbody align="center">
  <tr>
    <td colspan="8" width="50%">源端口</td>
    <td colspan="2" width="50%">目的端口</td>
  </tr>
  <tr>
    <td colspan="10">序号</td>
  </tr>
  <tr>
    <td colspan="10">确认号</td>
  </tr>
  <tr>
    <td width="12.5%">数据偏移</td>
    <td width="18.75%">保留</td>
    <td width="3.125%">URG</td>
    <td width="3.125%">ACK</td>
    <td width="3.125%">PSH</td>
    <td width="3.125%">RST</td>
    <td width="3.125%">SYN</td>
    <td width="3.125%">FIN</td>
    <td colspan="2" width="50%">窗口</td>
  </tr>
  <tr>
    <td colspan="8" width="50%">校验和</td>
    <td colspan="2" width="50%">紧急指针</td>
  </tr>
  <tr>
    <td colspan="9" width="75%">选项（长度可变）</td>
    <td width="25%">填充</td>
  </tr>
  <tr>
    <td colspan="10">数据部分</td>
  </tr>
</tbody>
</table>

- 序号：共有 $2^{32}$ 个。按字节逐个编号，序号字段为本报文段发送数据的第一个字节的序号
- 确认号：期望收到对方的下一个报文段的第一个字节序号。确认号为 $N$，说明 $N-1$ 为止的数据已确认收到
- 数据偏移：即首部长度。单位为 4B，最大值 15，即 60B。首部固定长度为 20B
- 保留：保留为今后使用，置 0
- 紧急位 URG：1 表明报文段中有紧急数据，应尽快传送（即高优先级）。数据从第一个字节到紧急指针所指字节为紧急数据
- 确认位 ACK：1 时确认号字段有效。TCP 规定，连接建立后所有报文段都将 ACK 置 1
- 推送位 PSH：1 表明收到该报文段应尽快交付给应用进程，无需等缓存填满
- 复位位 RST：1 表明 TCP 连接中出现严重差错（主机崩溃等），须释放并重新建立连接
- 同步位 SYN：1 表明连接请求或连接确认报文

  连接请求：$\text{SYN}=1$，$\text{ACK}=0$  
  连接确认：$\text{SYN}=1$，$\text{ACK}=1$

- 终止位 FIN：1 表明发送方的数据已发送完毕，要求释放连接
- 窗口：指出现在允许对方发送的数据量，最大为 $2^{16}-1$
- 校验和：校验首部和数据，方式类似 [UDP](#udp-校验)（其中伪首部的协议字段由 17 改为 6）
- 紧急指针：指出紧急数据有多少字节，其中紧急数据在数据部分最前面。仅在 $\text{URG}=1$ 时有意义
- 选项：长度可变。可选最大报文段长度（Maximum Segment Size, MSS），为**数据字段**的最大长度
- 填充：首部长度须为 4B 整数倍

:memo: 最佳的 MSS 难以确定，默认值为 536B，即此时报文段长度为 556B

#### TCP 连接管理

TCP 连接的端点为套接字（Socket），每条连接由通信的两个套接字唯一确定  
采用 C/S 模式，发起连接的应用进程为客户，等待连接的为服务器

##### TCP 连接建立（三次握手）

1. 连接建立前，服务器处于 LISTEN 状态。客户机 TCP 向服务器 TCP 发送连接请求报文段，$\text{SYN}=1$，设定初始序号 $\text{seq}=x$。客户进程进入 SYN-SENT 状态
2. 服务器收到连接请求报文段，若同意建立连接，则发回确认报文段，$\text{SYN}=1$，$\text{ACK}=1$，确认号 $\text{ack}=x+1$，设定初始序号 $\text{seq}=y$。为该 TCP 连接分配缓存和变量
3. 客户机收到确认报文段，向服务器发送确认，$\text{ACK}=1$，确认号 $\text{ack}=y+1$，序号 $\text{seq}=x+1$。为该 TCP 连接分配缓存和变量，客户进程进入 ESTABLISHED 状态

:memo: 连接请求和确认报文段均不能携带数据，但要消耗一个序号；客户机返回的确认报文段可携带数据，若无数据则不消耗序号  
:memo: 服务器的资源在第二次握手时分配，客户端的资源在第三次握手时分配，使得服务器容易受到 SYN 洪泛攻击

##### TCP 连接释放（四次握手）

参与连接的两个进程中任何一个都可终止该连接

1. 客户机发送连接释放报文段，$\text{FIN}=1$，序号 $\text{seq}=u$（最后发送的字节序号加 1）。即使无数据也消耗一个序号。客户进程停止发送数据，进入 FIN-WAIT-1 状态
2. 服务器收到连接释放报文段，返回确认，$\text{ACK}=1$，确认号 $\text{ack}=u+1$，序号 $\text{seq}=v$。服务器进入 CLOSE-WAIT 状态。此时服务器仍能向客户机发送数据
3. 服务器发送连接释放报文段，$\text{FIN}=1$，$\text{ACK}=1$，确认号 $\text{ack}=u+1$，序号 $\text{seq}=w$。服务器进入 LAST-ACK 状态
4. 客户机收到连接释放报文段，返回确认，$\text{ACK}=1$，确认号 $\text{ack}=w+1$，序号 $\text{seq}=u+1$。客户机进入 TIME-WAIT 状态。经过 $2\text{MSL}$（最长报文段寿命）后，客户机进入 CLOSED 状态

:memo: 等待 $2\text{MSL}$ 保证最后的确认报文段能到达服务器，且本连接持续时间内产生的所有报文段均已从网络中消失

#### TCP 可靠传输

1. 序号
2. 确认
3. 重传

   - 超时：报文段超时仍未收到确认，则重传

     报文段的往返时间（Round-Trip Time, RTT）：报文段发出时间与收到确认时间之差  
     TCP 保留 RTT 的加权平均时间 RTT~s~，并随新增样本变化  
     超时重传时间（Retransmission Time-Out, RTO）：应略大于 RTT~s~

   - 冗余 ACK

     再次确认某个报文段的 ACK  
     当发送方收到对同一个报文段的 3 个冗余 ACK，立即对下一个报文执行重传，称为**快速重传**

   :memo: 若收到失序报文段，放入缓存，此时发送方只需重传丢失报文段（与 [GBN](#多帧滑动窗口协议与后退-n-帧协议gbn) 不同）

#### TCP 流量控制

基于滑动窗口协议

接收窗口 rwnd
: 接收方根据自身接收缓存大小，调整窗口字段值，限制发送方的发送窗口大小

拥塞窗口 cwnd
: 发送方根据对网络拥塞程度的估计确定窗口值，与网络带宽和时延相关

发送方的实际发送窗口大小取 $\min\{\text{rwnd},\text{cwnd}\}$

:memo: 数据链路层中，窗口大小不能动态变化；传输层的可动态变化

#### TCP 拥塞控制

以下忽略 rwnd 的大小

##### 慢开始算法

1. 最开始发送报文段时令 $\text{cwnd}=1$（表示一个 MSS），规定慢开始门限 $\text{ssthresh}$（阈值）
2. 每收到一个对新报文段的确认，$\text{cwnd}+1$
3. 此时每经过一个 RTT，$\text{cwnd}$ 会加倍，但不能超过 $\text{ssthresh}$
4. $\text{cwnd}\geq\text{ssthresh}$ 时，改用拥塞避免算法

##### 拥塞避免算法

1. 每经过一个 RTT，$\text{cwnd}+1$
2. 无论在慢开始还是拥塞避免阶段，若出现拥塞（未按时收到确认），$\text{ssthresh}=\max\{\frac{\text{cwnd}}{2},2\}$，$\text{cwnd}=1$

##### 快重传

接收方每收到一次失序报文段就重新发送对最后正确接收报文段的 ACK，称为冗余 ACK  
发送方连续收到三个重复 ACK，认为报文段丢失，忽略计时器直接重传

##### 快恢复

1. 连续收到三个冗余 ACK 时，$\text{ssthresh}=\max\{\frac{\text{cwnd}}{2},2\}$，$\text{cwnd}=\text{ssthresh}$
2. 后续执行拥塞避免算法

## 应用层

### 网络应用模型

#### 客户/服务器（Client/Server, C/S）模型

服务器服务客户机的主机请求

1. 服务器处于接受请求状态
2. 客户机发出服务请求，等待接收结果
3. 服务器收到请求，分析并处理，将结果发送至客户机

客户程序须知道服务器程序的地址

如 Web、FTP、远程登陆、电子邮件等

- 网络中各计算机地位不平等，服务器可管理客户机，限制其存储等活动
- 客户机之间不直接通信
- 可扩展性不佳，服务器可支持的客户机数量有限

#### P2P 模型

任意一对计算机称为对等方（Peer），可直接相互通信  
每个结点同时具有下载、上传的功能，权利和义务大体对等  
结点既作为客户访问资源，也作为服务器提供资源

如 Bittorrent

- 减轻了服务器的计算压力，将任务分配至各个结点，提高系统效率和资源利用率
- 多个客户机之间可直接共享文档
- 可扩展性好
- 网络健壮性强，单个结点失效不影响其他结点
- 内存占用较大

### 域名系统（Domain Name System, DNS）

采用 C/S 模型，基于 UDP，端口号 53  
标号由 . 分隔

- 不区分大小写
- 标号中除 - 外不能使用其他符号
- 标号不超过 63 个字符，完整域名不超过 255 个字符

顶级域名（Top Level Domain, TLD）分类：

1. 国家/地区顶级域名（nTLD）：如 .cn、.us、.uk
2. 通用顶级域名（gTLD）：如 .com（公司）、.net（网络服务机构）、.org（非营利性组织）、.gov（国家政府部门）
3. 基础结构域名：arpa，用于反向域名解析，又称反向域名

每个组织可将域再次分成一定数目的子域，委托其他组织管理

#### 域名服务器

联机分布式数据库系统，采用 C/S 模型  
一个服务器管辖的范围称为区，一个区内的所有结点连通  
域名服务器保存区中所有主机的域名到 IP 地址的映射  
域名服务器可连向其他域名服务器

1. 根域名服务器
   : 最高层次的域名服务器，知道所有顶级域名服务器的 IP 地址，共 13 个。通常不直接给出 IP 地址
2. 顶级域名服务器
   : 管理该顶级域名下注册的所有二级域名
3. 授权域名服务器（权限域名服务器）
   : 每台主机须在授权域名服务器登记（至少两个）。许多可同时充当本地域名服务器。可直接转换的到 IP 地址
4. 本地域名服务器
   : 主机发出 DNS 查询请求时，报文就发送给本地域名服务器

#### 域名解析过程

正向解析
: 域名映射为 IP 地址

反向解析
: IP 地址映射为域名

主机的 DNS 客户端以 UDP 方式将 DNS 请求报文发送至本地域名服务器

##### 递归查询

主机 $\rightleftharpoons$ 本地域名服务器 $\rightleftharpoons$ 根域名服务器 $\rightleftharpoons$ 顶级域名服务器 $\rightleftharpoons$ 权限域名服务器

##### 递归与迭代相结合的查询

1. 主机向本地域名服务器递归查询
2. 本地域名服务器向根域名服务器迭代查询

域名服务器中使用高速缓存保存查询得到的 DNS 信息，相同查询到达时可直接给出 IP 地址  
高速缓存中的信息在一段时间后丢弃

### 文件传输协议（File Transfer Protocol, FTP）

采用 C/S 模型，基于 TCP，端口号 21

- 支持不同种类主机系统之间的文件传输
- 以用户权限管理的方式提供用于对远程 FTP 服务器上的文件管理能力
- 以匿名 FTP 的方式提供共用文件共享的能力

一个 FTP 服务器进程可同时为多个客户进程提供服务

组成：

- 主进程：负责接收新的请求
- 从属进程：若干，负责处理单个请求

工作步骤：

1. 打开控制端口
2. 等待客户进程发起连接请求
3. 启动从属进程处理客户进程发来的请求，与主进程并发执行。处理完毕后即终止该从属进程
4. 回到等待状态

FTP 服务器在整个会话期间保留用户的状态信息，将指定的用户账户与控制连接联系起来，追踪用户在远程目录树上的当前位置

#### 控制连接与数据连接

FTP 工作时使用两个并行的 TCP 连接：控制连接（端口号 21）、数据连接（端口号 20）  
使用分离的控制连接，也称带外（Out-of-band）传送

- 控制连接
  : 传输控制信息（连接请求、传送请求等），以 7 位 ASCII 格式传送。不用于传送文件。在整个会话期间保持打开
- 数据连接
  : 收到文件传输请求后即创建，用于连接客户端和服务器的数据传送进程。传送完毕后关闭连接

  - 主动模式 PORT：客户端随机开放端口，服务器 20 端口与之连接
  - 被动模式 PASV：服务器随机开放端口，客户端与之连接

  模式选择权在客户端，由客户端发送 PORT/PASV 命令到服务器

修改服务器上的文件需要先传送到本地主机，再将修改后的副本传送回服务器  
网络文件系统（NFS）允许进程打开远程文件并在特定位置开始读写

### 电子邮件

组成构件：

- 用户代理（User Agent, UA）
  : 用户与电子邮件系统的接口，具有撰写、显示和邮件处理的功能。如电子邮件客户端软件
- 邮件服务器
  : 发送和接收邮件，向发信人报告邮件传送的情况。采用 C/S 模型，两方服务器互为 C/S
- 发送协议和读取协议
  : 发送协议使 UA/邮件服务器向邮件服务器发送邮件（Push），如 SMTP；读取协议使 UA 向邮件服务器读取邮件（Pull），如 POP3、IMAP

1. 发信人调用 UA 撰写邮件，UA 通过 SMTP 将邮件传送给发送端邮件服务器
2. 发送端邮件服务器将邮件放入缓存队列，等待发送
3. 发送端邮件服务器上的 SMTP 客户进程向接收端 SMTP 服务器进程发起 TCP 连接
4. SMTP 客户进程发送邮件。所有邮件发送完毕后，关闭 TCP 连接
5. 接收端进程收到邮件，放入用户邮箱
6. 收信人调用 UA，通过 POP3/IMAP 将邮件从用户邮箱中取回

#### 电子邮件格式

- From：发信邮件地址，必需，由系统自动填入
- To：一个或多个收件人的电子邮件地址，必需
- Subject：邮件主题，可选

#### 多用途网际邮件扩充（Multipurpose Internet Mail Extensions, MIME）

继续使用目前的格式，但增加了邮件主体的结构  
定义了传送非 ASCII 码的编码规则

- 5 个新的邮件首部字段：MIME 版本、内容描述、内容标识、传送编码、内容类型
- 定义邮件内容的格式，对多媒体的表示方法进行了标准化
- 定义了传送编码，可对任何内容格式进行转换

#### 简单邮件传输协议（Simple Mail Transfer Protocol, SMTP）

采用 C/S 模型，基于 TCP，端口号 25

1. SMTP 客户端每隔一定时间扫描邮件缓存，若发现邮件即与接收方 SMTP 服务器建立 TCP 连接，服务器回答 220 Service ready。客户端发送 HELO 命令，附上发送方主机名。TCP 在发送方和接收方之间直接建立，不使用中间的服务器
2. 客户端发送 MAIL 命令，附上发件人地址，接收方回答 250 OK。发送若干 RCPT 命令，确认收件人地址，服务器回答 250/550。发送 DATA 命令传输内容，服务器回答 354 Start mail input。&lt;CRLF&gt;.&lt;CRLF&gt; 表示邮件内容结束
3. 邮件发送完毕，客户端发送 QUIT 命令，服务器返回 221，释放 TCP 连接

#### POP3 和 IMAP

POP 采用 C/S 模型，基于 TCP，端口号 110

POP3 采用拉（Pull）的通信方式，用户读取邮件时，UA 向邮件服务器发出请求，拉取邮箱中的邮件  
两种工作方式：下载并保留、下载并删除

IMAP 提供创建文件夹、移动邮件、在远程文件夹中查询邮件等联机命令  
IMAP 维护了会话用户的状态信息  
允许 UA 只获取报文的某些部分

基于万维网的电子邮件：用户浏览器与邮件服务器之间使用 HTTP

### 万维网（World Wide Web, WWW）

- 统一资源定位符（URL）
  : 唯一标识万维网上的各种文档
- 超文本传输协议（HTTP）
  : 应用层协议，使用 TCP 连接，万维网客户和服务器程序交互须遵守
- 超文本标记语言（HTML）
  : 标记语言，对页面上的各种信息进行描述

URL 的一般形式：<协议>://<主机>:<端口>/<路径>  
URL 不区分大小写

1. Web 用户使用浏览器与 Web 服务器建立连接，发送浏览请求
2. Web 服务器把 URL 转换为文件路径，返回信息给 Web 浏览器
3. 通信完成后关闭连接

#### 超文本传输协议（Hyper Text Transmission Protocol, HTTP）

端口号 80  
两类报文：请求报文、响应报文

1. 浏览器分析链接指向页面的 URL
2. 浏览器向 DNS 请求解析主机的 IP 地址
3. DNS 返回 IP 地址
4. 浏览器与该服务器建立 TCP 连接
5. 浏览器发出 HTTP 请求
6. 服务器发出 HTTP 响应，发送 URL 指向的文件至浏览器
7. 释放 TCP 连接
8. 浏览器解释文件，将 Web 页显示给用户

- HTTP 使用 TCP，但 HTTP 本身是无连接的
- HTTP 无状态，服务器不记忆客户的状态
- 使用 Cookie 加数据库跟踪用户的活动

非持久连接
: 每个网页元素对象的传输都需要单独建立一个 TCP 连接

持久连接
: 同一个客户和服务器保持连接，可传输后续请求。分为非流水线（客户收到前一个响应后才能发送下一个请求）和流水线（客户可逐个连续发送请求）两种方式

HTTP/1.1 默认使用流水线的持久连接

##### HTTP 报文结构

面向文本，故报文中的每个字段都是 ASCII 码串，且长度不确定

<table>
  <tr>
    <td>方法/版本</td>
    <td>&nbsp;</td>
    <td>URL/状态码</td>
    <td>&nbsp;</td>
    <td>版本/短语</td>
    <td>CRLF</td>
  </tr>
</table>
<table>
  <tr>
    <td>首部字段名</td>
    <td>:</td>
    <td>&nbsp;</td>
    <td>值</td>
    <td>CRLF</td>
  </tr>
  <tr>
    <td>首部字段名</td>
    <td>:</td>
    <td>&nbsp;</td>
    <td>值</td>
    <td>CRLF</td>
  </tr>
</table>
<table>
  <tr>
    <td>CRLF</td>
  </tr>
</table>
<table>
  <tr>
    <td>实体主体</td>
  </tr>
</table>

- 开始行：用于区分请求报文和响应报文。请求行中字段为方法、URL、版本；状态行中字段为版本、状态码、短语。三个字段间以空格分隔
- 首部行：说明信息，可有若干行或不使用，由字段名和值组成
- 实体主体：请求报文中一般不使用，有些响应报文不使用

请求报文中常用的方法：

- GET：请求 URL 标识的信息
- HEAD：请求 URL 标识的信息的首部
- POST：给服务器添加信息（如注释）
- CONNECT：用于代理服务器
